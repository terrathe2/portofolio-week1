<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>To Do Fancy API</title>
    <!-- <script type="text/javascript" href="/assets/JS/jquery.3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script> -->
    <link rel="stylesheet" href="/assets/CSS/style.css">
    <script
			  src="https://code.jquery.com/jquery-3.2.1.min.js"
			  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
			  crossorigin="anonymous">
    </script>
    <!-- <script href="assets/JS/validate-email.js"></script> -->
  </head>
  <body>
    <!-- Facebook SDK -->
  <script type="text/javascript">
    function statusChangeCallback(response) {
      console.log(response);
      if (response.status === 'connected') {
        // Logged into your app and Facebook.

        let inputData = {
          token: response.authResponse.accessToken,
          userID: response.authResponse.userID
        }

        console.log(inputData);
        $.ajax({
          type: 'post',
          url: 'http://localhost:3000/users/fblogin',
          data: inputData,
          dataType: 'json',
          success: function(respon){
            if (!respon.data) {
              // console.log("HAI");
              $("#logerror").html(respon.message)
            } else {

              localStorage.setItem('token', respon.data)
              window.location.reload()
            }
          },
          fail: function(){
            console.log("ERROR");
          }
        })
      } else {
        $('#loginform').show(200)
      }
    }

    function checkLoginState() {
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    }

    window.fbAsyncInit = function() {
      FB.init({
        appId      : 195417424336474,
        cookie     : true,
        xfbml      : true,
        version    : 'v2.10'
      });
      FB.AppEvents.logPageView();
    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "//connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>


<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -->

    <form id="loginform" method="post">
      <h2>Login</h2>
      <span id="logerror"></span><br><br>
      <input type="text" name="username" placeholder="Username" required /><br><br>
      <input type="password" name="password" placeholder="Password" required /><br><br>
      <fb:login-button size='xlarge' scope="public_profile,email" onlogin="checkLoginState();">.</fb:login-button>
      <!-- <a type="button" onclick="checkLoginState()" name="button">Facebook</a> -->
      <input type="submit" value="Login"/> <a id="register">Register</a>
    </form>

    <form id="registerform" method="post">
      <h2>Register</h2>
      <span id="signerror"></span><br><br>
      <input type="text" name="signusername" placeholder="Username" required /><br><br>
      <input type="password" name="signpassword" placeholder="Password" required /><br><br>
      <input id="email" type="email" name="signemail" placeholder="Email" required /> <span id="emailerr"></span><br><br>
      <input type="submit" value="Register" /> <a class="back">Back</a>
    </form>

    <div id="content" >
      <button id="logout" onclick="return logout()">Logout</button>
      <h2>My ToDo List</h2>
      <table class="todolist">
        <tbody>

        </tbody>
      </table><br>
      <button id="togle">Show Add Todo Form</button>

    </div>
    <form id="inputform" method="post">
      <textarea name="description" rows="8" cols="50" placeholder="Description" required></textarea><br><br>
      <input type="date" name="deadline" placeholder="Deadline Date ~ YYYY/MM/DD"><br><br>
      <input type="submit" name="submit" value="Add Todo">
    </form>
  </body>

  <script type="text/javascript">

    $(document).ready(function(){
      if (localStorage.getItem('token')) {
        $('#content').show(200)
      } else {
        $('#loginform').show(200)
      }

      $('#logout').on('click', function(){
        localStorage.removeItem('token')
        FB.logout()

        window.location.reload()
      })

      // Login
      $('#loginform').on('submit', function(ev) {
        ev.preventDefault();

        let inputData = {
          username: $('input[name=username]').val(),
          password: $('input[name=password]').val()
        }

        $.ajax({
          type: 'post',
          url: 'http://localhost:3000/users/login',
          data: inputData,
          dataType: 'json',
          success: function(response) {
            if (!response.data) {
              $("#logerror").html(response.message)
            } else {
              localStorage.setItem('token', response.data)
              window.location.reload()
            }
          },

          fail: function() {
            console.log("ERROR")
          }
        })
      })

      // Register
      $('#registerform').on('submit', function(ev) {
        ev.preventDefault();

        let inputData = {
          username: $('input[name=signusername]').val(),
          password: $('input[name=signpassword]').val(),
          email: $('input[name=signemail]').val()
        }

        $.ajax({
          type: 'post',
          url: 'http://localhost:3000/users/register',
          data: inputData,
          dataType: 'json',
          success: function(response) {
            if (!response.data) {
              $("#signerror").html(response.message)
            } else {
              localStorage.setItem('token', response.data)
              window.location.reload()
            }
          },

          fail: function() {
            console.log("ERROR")
          }
        })
      })

      // Input form
      $('#inputform').on('submit', function(ev){
        ev.preventDefault();

        let inputData = {
          token: localStorage.getItem('token'),
          description: $('textarea[name=description]').val(),
          deadline: $('input[name=deadline]').val()
        }
        // console.log(inputData);
        $.ajax({
          type: 'post',
          url: 'http://localhost:3000/todos/insert',
          data: inputData,
          dataType: 'json',
          success: function(response){
            console.log(response);
            window.location.reload()
          },
          fail: function(){
            console.log("ERROR");
          }
        })
      })

      $('.todolist').ready(function(){
        let token = localStorage.getItem('token')
        $.ajax({
          type: 'get',
          url: 'http://localhost:3000/todos/'+token,
          dataType: 'json',
          success: function(response) {
            console.log(response);
            if (response.data) {
              let tombol = ''
              let mark = ''
              let arrMonth = ['January','February','March','April','May','June','July','August','September','October','November','December']
              response.data.forEach((todolist, index) => {
                if (todolist.status){
                  tombol = 'hidden'
                  mark = "<img src='assets/images/true.png' width='20px'>"
                } else {
                  tombol = ''
                  mark = "<img src='assets/images/false.png' width='20px'>"
                }

                let formatedDL = "Not Set"

                if (todolist.deadline != null) {
                  let deadline = new Date(todolist.deadline);
                  formatedDL = deadline.getDate()+" "+arrMonth[deadline.getMonth()]+" "+deadline.getFullYear()
                }

                $('tbody').append(
                  "<tr>"+
                    "<td>"+mark+"</td>"+
                    // "<td>"+todolist._id+".</td>"+
                    "<td>"+todolist.description+"</td>"+
                    "<td> ~~~ </td>"+
                    "<td>Deadline : "+formatedDL+"</td>"+
                    "<td>"+
                      "<button class='finish upd"+index+"' "+tombol+">Finished</button> "+
                      "<button class='delete dlt"+index+"' >Delete</button>"+
                    "</td>"+
                  "</tr>"
                )

                Action.update(todolist._id, index)
                Action.delete(todolist._id, index)

              })
            }
          },

          fail: function() {
            console.log("ERROR")
          }
        })
      })

      // Action
      let Action = {
        delete: (id, index) => {
          $(".dlt"+index).on('click', function(){
            $.ajax({
              type: 'delete',
              url: 'http://localhost:3000/todos/delete/'+id,
              dataType: 'json',
              success: function(response) {
                window.location.reload()
              },

              fail: function() {
                console.log("ERROR")
              }
            })
          })
        },

        update: (id, index) => {
          $(".upd"+index).on('click', function(){
            $.ajax({
              type: 'put',
              url: 'http://localhost:3000/todos/update/'+id,
              dataType: 'json',
              success: function(response) {
                window.location.reload()
              },

              fail: function() {
                console.log("ERROR")
              }
            })
          })
        }
      }

      // email validation regex
      $('#email').on('keypress', function(){
        let pattern = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
        if (!pattern.test(this.value)) {
          $('#emailerr').html("<img src='assets/images/false.png' width='12px'> Invalid Email").css({"color":"red"}).show()
        } else {
          $('#emailerr').html("<img src='assets/images/true.png' width='12'> Cool Email!").css({"color": "green"}).show()
        }
      })

      $('#register').on('click', function(){
        $('#loginform').hide(200)
        $('#registerform').show(200)
      })

      $('.back').on('click', function(){
        $('#loginform').show(200)
        $('#registerform').hide(200)
      })

      $('#togle').on('click', function(){
        if ($(this).text() === "Show Add Todo Form"){
          $(this).text("Hide Add Todo Form").css({'background-color':'white', 'color':'orange'})
        } else {
          $(this).text("Show Add Todo Form").css({'background-color':'orange', 'color':'white'})
        }

        $('#inputform').toggle(200)
      })

    })
  </script>
</html>
